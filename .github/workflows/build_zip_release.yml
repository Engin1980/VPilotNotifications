name: Release build and deploy

on:
  push:
    branches:
      - master

permissions:
  contents: write  # nutnÃ© pro release a GitHub Pages deploy

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      
      - name: Setup MSBuild for .NET Framework
        uses: microsoft/setup-msbuild@v2

      - name: Show module short version
        run: echo "Short Version = ${{ steps.module_version.outputs.short_version }}"        

      # restore all projects in solution (supports packages.config and PackageReference)
      - name: Restore solution (MSBuild)
        run: |
          msbuild VPilotNotificationsSolution.sln /t:Restore /p:RestorePackagesConfig=true

      # build .NET Framework project(s)
      - name: Build .NET 4.7.2 project
        run: |
          msbuild Base/VPilotNetCoreBridge/VPilotNetCoreBridge.csproj /p:Configuration=Release /p:OutputPath=..\..\out\plugin\

      # building module(s)

      - name: Build and publish
        run: |
          dotnet publish Implementations/VPilotNotifications/VPilotNotifications.csproj -c Release -o out/module

      - name: List all files
        run: |
          Get-ChildItem -Path .\out -Recurse


      # plugin version
      - name: Get plugin assembly version
        id: get_plugin_version
        run: |
          $file = Get-Item "./out/plugin/VPilotNetCoreBridge.dll"
          $version = $file.VersionInfo.FileVersion
          echo "VERSION=$version" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Normalize plugin version
        id: plugin_version
        run: |
          $fullVersion = "${{ steps.get_plugin_version.outputs.version }}"
          $shortVersion = ($fullVersion -split '\.')[0..2] -join '.'
          echo "short_version=$shortVersion" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Show plugin short version
        run: echo "Short Version = ${{ steps.plugin_version.outputs.short_version }}"


      # module version
      - name: Get version from module csproj
        id: get_module_version
        uses: KageKirin/get-csproj-version@v0
        with:
          file: Base/VPilotNetCoreModule/VPilotNetCoreModule.csproj
          xpath: //PropertyGroup/Version
          regex: ^(?<major>[0-9]+)\.(?<minor>[0-9]+)\.(?<patch>[0-9]+)(\.[0-9]+)?$

      - name: Normalize module version
        id: module_version
        run: |
          $fullVersion = "${{ steps.get_module_version.outputs.version }}"
          $shortVersion = ($fullVersion -split '\.')[0..2] -join '.'
          echo "short_version=$shortVersion" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Prepare plugin structure
        run: |
          Remove-Item -Path "out/plugin/RossCarlson.Vatsim.Vpilot.Plugins.dll" -ErrorAction SilentlyContinue
          Remove-Item -Path "out/plugin/RossCarlson.Vatsim.Vpilot.Plugins.xml" -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path "out/plugin/VPilotNotifications" -Force
          Copy-Item -Path "out/module/*" -Destination "out/plugin/VPilotNotifications/" -Recurse -Force
        shell: pwsh

      - name: Create release ZIP
        run: |
          $zipName = "plug-v${{ steps.plugin_version.outputs.short_version }}-mod-v${{ steps.module_version.outputs.short_version }}.zip"
          Compress-Archive -Path "out/plugin/*" -DestinationPath $zipName -Force
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.ZIP_NAME }}
          name: ${{ env.ZIP_NAME }}
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



